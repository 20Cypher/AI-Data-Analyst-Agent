<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Data Analyst Agent</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        color: white;
        padding: 40px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .main-content {
        padding: 40px;
      }

      .section {
        margin-bottom: 40px;
      }

      .section h2 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.5rem;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }

      .upload-zone {
        border: 3px dashed #3498db;
        border-radius: 12px;
        padding: 40px;
        text-align: center;
        background: #f8fafc;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .upload-zone:hover {
        border-color: #2980b9;
        background: #ebf3fd;
      }

      .upload-zone.dragover {
        border-color: #27ae60;
        background: #eafaf1;
      }

      .file-input {
        display: none;
      }

      .dataset-select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 16px;
        margin-bottom: 20px;
      }

      .question-input {
        width: 100%;
        min-height: 120px;
        padding: 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 16px;
        font-family: inherit;
        resize: vertical;
      }

      .analyze-btn {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        border: none;
        padding: 16px 32px;
        font-size: 18px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
      }

      .analyze-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(46, 204, 113, 0.3);
      }

      .analyze-btn:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      .results-section {
        display: none;
        border-top: 2px solid #ecf0f1;
        padding-top: 40px;
        margin-top: 40px;
      }

      .log-panel {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        font-family: "Monaco", "Courier New", monospace;
        font-size: 14px;
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 20px;
      }

      .results-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 20px;
      }

      .chart-container {
        text-align: center;
      }

      .chart-container img {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .summary-container {
        background: #f8fafc;
        padding: 24px;
        border-radius: 8px;
        border-left: 4px solid #3498db;
      }

      .download-btn {
        background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s ease;
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(155, 89, 182, 0.3);
      }

      .status-indicator {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        margin-left: 10px;
      }

      .status-running {
        background: #ffeaa7;
        color: #d63031;
      }

      .status-completed {
        background: #00b894;
        color: white;
      }

      .status-failed {
        background: #d63031;
        color: white;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: #ecf0f1;
        border-radius: 4px;
        overflow: hidden;
        margin: 20px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #00b894, #00cec9);
        transition: width 0.5s ease;
        width: 0%;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .loading {
        animation: pulse 1.5s infinite;
      }

      @media (max-width: 768px) {
        .results-grid {
          grid-template-columns: 1fr;
        }

        .main-content {
          padding: 20px;
        }

        .header {
          padding: 30px 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>AI Data Analyst Agent</h1>
        <p>Turn your data questions into comprehensive analysis reports</p>
      </div>

      <div class="main-content">
        <div class="section">
          <h2>1. Upload or Select Dataset</h2>
          <div class="upload-zone" id="uploadZone">
            <div id="uploadContent">
              <svg
                width="64"
                height="64"
                fill="#3498db"
                viewBox="0 0 24 24"
                style="margin-bottom: 16px"
              >
                <path
                  d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                />
              </svg>
              <p style="font-size: 18px; color: #3498db; margin-bottom: 8px">
                Drop your CSV or Parquet file here
              </p>
              <p style="color: #7f8c8d">or click to browse</p>
              <input
                type="file"
                id="fileInput"
                class="file-input"
                accept=".csv,.parquet"
              />
            </div>
          </div>

          <div style="margin: 20px 0; text-align: center; color: #7f8c8d">
            <span>— or select existing dataset —</span>
          </div>

          <select id="datasetSelect" class="dataset-select">
            <option value="">Loading datasets...</option>
          </select>
        </div>

        <div class="section">
          <h2>2. Ask Your Question</h2>
          <textarea
            id="questionInput"
            class="question-input"
            placeholder="Examples:
• What are monthly sales trends in 2023? Include a line chart and top 5 product categories.
• Compare average order value by region; return a bar chart and summary.
• Identify outliers in daily orders; show IQR stats and boxplot.
• Show churn by cohort; compute retention and plot heatmap.
• Is there seasonality? Run seasonal decomposition and explain peaks."
          ></textarea>

          <button id="analyzeBtn" class="analyze-btn" disabled>
            🚀 Start Analysis
          </button>
        </div>

        <div id="resultsSection" class="results-section">
          <h2>
            Analysis Results
            <span id="statusIndicator" class="status-indicator status-running"
              >Running</span
            >
          </h2>

          <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
          </div>

          <div id="logPanel" class="log-panel">
            <div>Initializing analysis...</div>
          </div>

          <div id="resultsGrid" class="results-grid" style="display: none">
            <div class="chart-container">
              <h3>Generated Charts</h3>
              <div id="chartsContainer"></div>
            </div>

            <div class="summary-container">
              <h3>Analysis Summary</h3>
              <div id="summaryContent">Analysis in progress...</div>

              <div style="margin-top: 20px">
                <a id="downloadBtn" class="download-btn" style="display: none">
                  📦 Download Complete Bundle
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      class DataAnalystApp {
        constructor() {
          this.currentRunId = null;
          this.eventSource = null;

          this.initializeElements();
          this.logEventSource = null;
          this.setupEventListeners();
          this.loadDatasets();
        }

        initializeElements() {
          this.uploadZone = document.getElementById("uploadZone");
          this.fileInput = document.getElementById("fileInput");
          this.datasetSelect = document.getElementById("datasetSelect");
          this.questionInput = document.getElementById("questionInput");
          this.analyzeBtn = document.getElementById("analyzeBtn");
          this.resultsSection = document.getElementById("resultsSection");
          this.statusIndicator = document.getElementById("statusIndicator");
          this.progressFill = document.getElementById("progressFill");
          this.logPanel = document.getElementById("logPanel");
          this.resultsGrid = document.getElementById("resultsGrid");
          this.summaryContent = document.getElementById("summaryContent");
          this.downloadBtn = document.getElementById("downloadBtn");
          this.chartsContainer = document.getElementById("chartsContainer");
        }

        setupLogStream(runId) {
          try {
            if (this.logEventSource) {
              this.logEventSource.close();
            }
            this.logEventSource = new EventSource(`/runs/${runId}/stream`);
            this.logEventSource.onmessage = (e) => {
              if (!e?.data) return;
              const msg = this.escapeHtml(e.data);
              const div = document.createElement("div");
              div.textContent = msg;
              this.logPanel.appendChild(div);
              this.logPanel.scrollTop = this.logPanel.scrollHeight;
            };
            this.logEventSource.onerror = () => {
              // Don’t spam errors; the polling fallback keeps status updated
            };
          } catch (err) {
            console.error("SSE not available:", err);
          }
        }

        closeLogStream() {
          try {
            if (this.logEventSource) {
              this.logEventSource.close();
              this.logEventSource = null;
            }
          } catch (_) {}
        }

        setupEventListeners() {
          // File upload
          this.uploadZone.addEventListener("click", () =>
            this.fileInput.click()
          );
          this.uploadZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            this.uploadZone.classList.add("dragover");
          });
          this.uploadZone.addEventListener("dragleave", () => {
            this.uploadZone.classList.remove("dragover");
          });
          this.uploadZone.addEventListener("drop", (e) => {
            e.preventDefault();
            this.uploadZone.classList.remove("dragover");
            const files = e.dataTransfer.files;
            if (files.length > 0) {
              this.fileInput.files = files;
              this.handleFileUpload();
            }
          });

          this.fileInput.addEventListener("change", () =>
            this.handleFileUpload()
          );

          // Dataset selection
          this.datasetSelect.addEventListener("change", () =>
            this.updateAnalyzeButton()
          );

          // Question input
          this.questionInput.addEventListener("input", () =>
            this.updateAnalyzeButton()
          );

          // Analysis button
          this.analyzeBtn.addEventListener("click", () => this.startAnalysis());
        }

        async loadDatasets() {
          try {
            const response = await fetch("/datasets");
            const datasets = await response.json();

            this.datasetSelect.innerHTML =
              '<option value="">Select a dataset...</option>';

            datasets.forEach((dataset) => {
              const option = document.createElement("option");
              option.value = dataset.dataset_id;
              option.textContent = `${dataset.filename} (${this.formatFileSize(
                dataset.size_bytes
              )})`;
              this.datasetSelect.appendChild(option);
            });
          } catch (error) {
            console.error("Failed to load datasets:", error);
            this.datasetSelect.innerHTML =
              '<option value="">Error loading datasets</option>';
          }
        }

        async handleFileUpload() {
          const file = this.fileInput.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);

          try {
            this.uploadZone.classList.add("loading");

            const response = await fetch("/datasets/upload", {
              method: "POST",
              body: formData,
            });

            if (!response.ok) {
              throw new Error(`Upload failed: ${response.statusText}`);
            }

            const result = await response.json();

            // Reload datasets and select the new one
            await this.loadDatasets();
            this.datasetSelect.value = result.dataset_id;
            this.updateAnalyzeButton();

            // Update upload zone
            document.getElementById("uploadContent").innerHTML = `
                        <div style="color: #27ae60;">
                            <svg width="48" height="48" fill="currentColor" viewBox="0 0 24 24" style="margin-bottom: 12px;">
                                <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z" />
                            </svg>
                            <p>✅ ${result.filename} uploaded successfully!</p>
                        </div>
                    `;
          } catch (error) {
            console.error("Upload failed:", error);
            alert("Upload failed: " + error.message);
          } finally {
            this.uploadZone.classList.remove("loading");
          }
        }

        updateAnalyzeButton() {
          const hasDataset = this.datasetSelect.value.trim() !== "";
          const hasQuestion = this.questionInput.value.trim() !== "";

          this.analyzeBtn.disabled = !hasDataset || !hasQuestion;
        }

        async startAnalysis() {
          const dataset_id = this.datasetSelect.value;
          const question = this.questionInput.value.trim();

          if (!dataset_id || !question) {
            alert("Please select a dataset and enter a question.");
            return;
          }

          try {
            // Start analysis
            const response = await fetch("/analyze", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ dataset_id, question }),
            });

            if (!response.ok) {
              throw new Error(
                `Analysis failed to start: ${response.statusText}`
              );
            }

            const result = await response.json();
            this.currentRunId = result.run_id;

            // Show results section
            this.resultsSection.style.display = "block";
            this.resultsGrid.style.display = "none";
            this.downloadBtn.style.display = "none";

            // Start live log stream (SSE)
            this.setupLogStream(this.currentRunId);

            // Reset UI
            this.statusIndicator.textContent = "Running";
            this.statusIndicator.className = "status-indicator status-running";
            this.progressFill.style.width = "10%";
            this.logPanel.innerHTML = "<div>Analysis started...</div>";
            this.summaryContent.textContent = "Analysis in progress...";

            // Start monitoring
            this.monitorAnalysis();

            // Disable analyze button
            this.analyzeBtn.disabled = true;
            this.analyzeBtn.textContent = "⏳ Analyzing...";
          } catch (error) {
            console.error("Failed to start analysis:", error);
            alert("Failed to start analysis: " + error.message);
          }
        }

        async monitorAnalysis() {
          if (!this.currentRunId) return;

          // Poll for status updates
          const pollStatus = async () => {
            try {
              const response = await fetch(`/runs/${this.currentRunId}`);
              const status = await response.json();

              this.updateProgress(status);

              if (status.status === "completed") {
                this.handleAnalysisComplete(status);
                return;
              } else if (
                status.status === "failed" ||
                status.status === "error"
              ) {
                this.handleAnalysisError(status);
                return;
              }

              // Continue polling
              setTimeout(pollStatus, 2000);
            } catch (error) {
              console.error("Status polling failed:", error);
              setTimeout(pollStatus, 5000); // Retry with longer delay
            }
          };

          pollStatus();
        }

        updateProgress(status) {
          // Update status indicator
          this.statusIndicator.textContent =
            status.status.charAt(0).toUpperCase() + status.status.slice(1);
          this.statusIndicator.className = `status-indicator status-${status.status}`;

          // Update progress bar
          this.progressFill.style.width = `${status.progress}%`;

          // Update log messages
          if (status.messages && status.messages.length > 0) {
            this.logPanel.innerHTML = status.messages
              .map((msg) => `<div>${this.escapeHtml(msg)}</div>`)
              .join("");
            this.logPanel.scrollTop = this.logPanel.scrollHeight;
          }
        }

        async handleAnalysisComplete(status) {
          this.closeLogStream();
          this.statusIndicator.textContent = "Completed";
          this.statusIndicator.className = "status-indicator status-completed";
          this.progressFill.style.width = "100%";

          // Enable analyze button
          this.analyzeBtn.disabled = false;
          this.analyzeBtn.textContent = "🚀 Start Analysis";

          // Show results
          await this.loadAnalysisResults();

          // Show download button
          if (status.bundle_path) {
            this.downloadBtn.href = `/runs/${this.currentRunId}/bundle`;
            this.downloadBtn.style.display = "inline-block";
          }
        }

        handleAnalysisError(status) {
          this.closeLogStream();
          this.statusIndicator.textContent = "Failed";
          this.statusIndicator.className = "status-indicator status-failed";

          // Enable analyze button
          this.analyzeBtn.disabled = false;
          this.analyzeBtn.textContent = "🚀 Start Analysis";

          // Show error in summary
          this.summaryContent.innerHTML = `
                    <div style="color: #e74c3c;">
                        <h4>Analysis Failed</h4>
                        <p>The analysis encountered an error. Please check your question and dataset, then try again.</p>
                        ${
                          status.messages
                            ? "<p><strong>Details:</strong> " +
                              status.messages.join(", ") +
                              "</p>"
                            : ""
                        }
                    </div>
                `;
        }

        async loadAnalysisResults() {
          try {
            // Fetch available artifacts for this run
            const res = await fetch(`/runs/${this.currentRunId}/artifacts`);
            if (!res.ok)
              throw new Error(`Artifacts listing failed: ${res.statusText}`);
            const meta = await res.json();

            // Render summary.md (fallback to a message if missing)
            if (meta.summary) {
              const sres = await fetch(meta.summary);
              const text = sres.ok
                ? await sres.text()
                : "Summary not available.";
              // Render markdown as plain text (safe); you can plug a markdown renderer later
              this.summaryContent.textContent = text;
            } else {
              this.summaryContent.textContent = "Summary not available.";
            }

            // Render charts
            this.chartsContainer.innerHTML = "";
            if (Array.isArray(meta.charts) && meta.charts.length > 0) {
              for (const url of meta.charts) {
                const wrapper = document.createElement("div");
                wrapper.style.marginBottom = "16px";
                const img = document.createElement("img");
                img.src = url;
                img.alt = "Chart";
                img.loading = "lazy";
                wrapper.appendChild(img);
                this.chartsContainer.appendChild(wrapper);
              }
            } else {
              this.chartsContainer.innerHTML = `
                    <div style="background: #f8fafc; padding: 40px; border-radius: 8px; border: 2px dashed #3498db;">
                        <svg width="64" height="64" fill="#3498db" viewBox="0 0 24 24" style="margin-bottom: 16px;">
                            <path d="M3.5,18.49L9.5,12.48L13.5,16.48L22,6.92L20.59,5.51L13.5,13.39L9.5,9.39L2.39,17.46L3.5,18.49Z" />
                        </svg>
                        <p style="color: #3498db; margin: 0;">No charts available for this run.</p>
                    </div>
                `;
            }

            this.resultsGrid.style.display = "grid";
          } catch (error) {
            console.error("Failed to load results:", error);
            this.summaryContent.innerHTML = `
                <div style="color: #e74c3c;">
                    <h4>Could not load artifacts</h4>
                    <p>${this.escapeHtml(error.message)}</p>
                </div>
            `;
          }
        }

        formatFileSize(bytes) {
          if (!bytes) return "Unknown size";

          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(1024));
          return (
            Math.round((bytes / Math.pow(1024, i)) * 100) / 100 + " " + sizes[i]
          );
        }

        escapeHtml(unsafe) {
          return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }
      }

      // Initialize app when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        new DataAnalystApp();
      });
    </script>
  </body>
</html>
